{% extends 'base.html' %}
{% load i18n %}
{% load static %}
{% load custom_filters %}

{% block title %}{{ session.title }} | {% trans "Live Session" %} | PeerLearn{% endblock %}

{% block meta %}
<meta name="dashboard-url" content="{% if is_mentor %}{% url 'mentor_dashboard' %}{% else %}{% url 'learner_dashboard' %}{% endif %}">
{% endblock %}

{% block extra_css %}
<style>
    /* Full-screen layout for session room */
    body {
        overflow: hidden;
    }
    
    .session-room {
        height: calc(100vh - 64px); /* Full height minus navbar */
    }

    /* Enhanced pre-session countdown overlay with glassmorphism */
    .pre-session-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(to right bottom, rgba(15, 23, 42, 0.85), rgba(3, 7, 18, 0.95));
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 50;
        color: white;
        backdrop-filter: blur(8px);
        transition: opacity 0.4s ease;
    }
    
    .pre-session-overlay.fade-out {
        opacity: 0;
    }
    
    .pre-session-content {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 24px;
        padding: 3rem;
        max-width: 600px;
        width: 90%;
        box-shadow: 
            0 10px 25px -5px rgba(0, 0, 0, 0.2),
            0 8px 10px -6px rgba(0, 0, 0, 0.1),
            0 0 0 1px rgba(255, 255, 255, 0.1) inset;
        border: 1px solid rgba(255, 255, 255, 0.1);
        animation: content-glow 3s infinite alternate ease-in-out;
    }
    
    @keyframes content-glow {
        0% {
            box-shadow: 
                0 10px 25px -5px rgba(0, 0, 0, 0.2),
                0 8px 10px -6px rgba(0, 0, 0, 0.1),
                0 0 0 1px rgba(255, 255, 255, 0.1) inset;
        }
        100% {
            box-shadow: 
                0 15px 30px -5px rgba(59, 130, 246, 0.3),
                0 10px 15px -6px rgba(59, 130, 246, 0.2),
                0 0 0 1px rgba(99, 102, 241, 0.2) inset;
        }
    }
    
    .countdown-timer {
        font-size: 5rem;
        font-weight: 700;
        margin-bottom: 1.5rem;
        font-family: 'Courier New', monospace;
        text-shadow: 0 2px 10px rgba(59, 130, 246, 0.5);
        background: linear-gradient(to right, #3b82f6, #6366f1);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        position: relative;
        display: inline-block;
        letter-spacing: 4px;
        transition: all 0.3s ease;
    }
    
    .countdown-timer::after {
        content: '';
        position: absolute;
        bottom: -5px;
        left: 0;
        width: 100%;
        height: 3px;
        background: linear-gradient(to right, #3b82f6, #6366f1);
        border-radius: 3px;
    }
    
    .countdown-timer.animate-pulse {
        animation: countdown-pulse 1s infinite alternate;
    }
    
    @keyframes countdown-pulse {
        0% { transform: scale(1); opacity: 1; }
        100% { transform: scale(1.05); opacity: 0.9; }
    }
    
    .countdown-message {
        font-size: 1.6rem;
        margin-bottom: 2.5rem;
        text-align: center;
        max-width: 600px;
        line-height: 1.5;
        color: rgba(255, 255, 255, 0.9);
    }
    
    .notification-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background-color: red;
        animation: pulse 1s infinite;
    }
    
    @keyframes pulse {
        0% {
            transform: scale(1);
            opacity: 1;
        }
        50% {
            transform: scale(1.5);
            opacity: 0.7;
        }
        100% {
            transform: scale(1);
            opacity: 1;
        }
    }
    
    /* Video containers */
    .video-container {
        background-color: #1a1a1a;
        border-radius: 8px;
        overflow: hidden;
        position: relative;
    }
    
    .video-container.mentor {
        min-height: 400px;
    }
    
    .video-container.learner {
        min-height: 180px;
    }
    
    .video-container video {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    
    .video-container .label {
        position: absolute;
        bottom: 10px;
        left: 10px;
        background: rgba(0, 0, 0, 0.6);
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
    }
    
    .video-container .controls {
        position: absolute;
        bottom: 10px;
        right: 10px;
        display: flex;
        gap: 8px;
    }
    
    .video-container .controls button {
        background: rgba(0, 0, 0, 0.6);
        color: white;
        border: none;
        border-radius: 50%;
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
    }
    
    /* Network quality indicator */
    .network-quality {
        position: absolute;
        top: 10px;
        right: 10px;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 11px;
        display: flex;
        align-items: center;
        gap: 4px;
    }
    
    .network-quality.good {
        background: rgba(16, 185, 129, 0.8);
        color: white;
    }
    
    .network-quality.medium {
        background: rgba(245, 158, 11, 0.8);
        color: white;
    }
    
    .network-quality.poor {
        background: rgba(239, 68, 68, 0.8);
        color: white;
    }
    
    /* Buffering spinner */
    .buffering-indicator {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        display: none;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }
    
    .buffering-indicator .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: white;
        animation: spin 1s ease-in-out infinite;
    }
    
    .buffering-indicator .text {
        color: white;
        margin-top: 8px;
        font-size: 14px;
        text-align: center;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    
    /* Show buffering when video is stalled */
    .video-container.buffering .buffering-indicator {
        display: flex;
    }
    
    /* Sidebar tabs */
    .tab {
        cursor: pointer;
        padding: 10px 16px;
        font-weight: 500;
        border-bottom: 2px solid transparent;
    }
    
    .tab.active {
        border-bottom: 2px solid #3b82f6;
        color: #3b82f6;
    }
    
    /* Chat messages */
    .chat-messages {
        height: calc(100% - 60px);
        overflow-y: auto;
        padding: 16px;
    }
    
    .chat-message {
        margin-bottom: 12px;
    }
    
    .chat-message.self {
        text-align: right;
    }
    
    .chat-bubble {
        display: inline-block;
        padding: 8px 12px;
        border-radius: 12px;
        max-width: 80%;
        word-break: break-word;
    }
    
    .chat-message.self .chat-bubble {
        background-color: #e0f2fe;
        border-top-right-radius: 0;
    }
    
    .chat-message:not(.self) .chat-bubble {
        background-color: #f3f4f6;
        border-top-left-radius: 0;
    }
    
    .chat-message.system .chat-bubble {
        background-color: #e5e7eb;
        border-radius: 8px;
        width: 100%;
        text-align: center;
        font-size: 12px;
        padding: 4px 8px;
    }
    
    .chat-form {
        height: 60px;
        display: flex;
        padding: 12px;
        border-top: 1px solid #e5e7eb;
    }
    
    .chat-input {
        flex-grow: 1;
        border: 1px solid #d1d5db;
        border-radius: 24px;
        padding: 8px 16px;
        margin-right: 8px;
        outline: none;
    }
    
    .chat-submit {
        background-color: #3b82f6;
        color: white;
        border: none;
        border-radius: 50%;
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
    }
    
    /* Mobile adjustments */
    @media (max-width: 768px) {
        .session-room {
            flex-direction: column;
            overflow-y: auto;
            height: 100%;
        }
        
        #video-grid {
            display: flex;
            flex-direction: column;
            height: auto !important;
        }
        
        .video-container {
            height: auto;
            width: 100%;
            position: relative;
        }
        
        .video-container.mentor {
            min-height: 240px;
            height: 40vh;
            order: 1;
        }
        
        .video-container.learner {
            min-height: 120px;
            height: 25vh;
            order: 2;
        }
        
        .video-container.local {
            min-height: 120px;
            height: 20vh;
            order: 3;
        }
        
        .controls {
            position: fixed;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            border-radius: 24px;
            padding: 8px 16px;
            z-index: 30;
        }
    }
    
    /* Animation */
    .fade-out {
        opacity: 0;
        transition: opacity 0.3s ease-out;
    }
    
    /* Notification badge */
    .badge {
        position: absolute;
        top: -5px;
        right: -5px;
        width: 10px;
        height: 10px;
        background-color: #ef4444;
        border-radius: 50%;
    }
    
    /* Whiteboard */
    .whiteboard-container {
        width: 100%;
        height: 100%;
        background-color: white;
        border-radius: 8px;
        overflow: hidden;
    }
    
    #whiteboard-canvas {
        width: 100%;
        height: 100%;
    }
</style>
{% endblock %}

{% block content %}
<!-- Enhanced Pre-Session Countdown Overlay with Glassmorphism -->
<div id="pre-session-overlay" class="pre-session-overlay">
    <div class="pre-session-content">
        <div class="text-center mb-6">
            <h2 class="text-2xl font-bold mb-2 bg-gradient-to-r from-blue-400 to-indigo-500 text-transparent bg-clip-text">
                {% trans "Welcome to Your Live Session" %}
            </h2>
            <p class="text-gray-300 text-sm">
                {% trans "Session with" %} <span class="font-semibold">{{ session.mentor.user.get_full_name }}</span>
            </p>
        </div>
        
        <div class="flex flex-col items-center justify-center">
            <!-- Camera preview -->
            <div class="relative w-full max-w-md h-40 bg-gray-900 rounded-lg mb-6 overflow-hidden">
                <video id="local-video" autoplay muted playsinline class="w-full h-full object-cover"></video>
                <div class="absolute bottom-2 right-2 bg-black bg-opacity-60 px-2 py-1 rounded text-xs text-white">
                    {% trans "Camera Preview" %}
                </div>
            </div>
            
            <!-- Countdown timer -->
            <div class="countdown-timer" id="countdown-timer">00:00:00</div>
            <div class="countdown-message" id="countdown-message">
                {% trans "Please make sure your camera and microphone are working properly." %}
            </div>
        </div>
        
        <div class="flex flex-col items-center space-y-4 mt-4">
            <div class="bg-blue-900 bg-opacity-30 text-blue-100 p-4 rounded-lg max-w-md border border-blue-800">
                <div class="flex items-center">
                    <i data-feather="info" class="h-5 w-5 mr-2 text-blue-300"></i>
                    <p class="text-sm">{% trans "You can test your audio and video before joining the session." %}</p>
                </div>
            </div>
            
            <button id="ready-btn" class="bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white font-bold py-3 px-8 rounded-lg text-lg transition shadow-lg">
                {% trans "I'm Ready to Join!" %}
            </button>
            
            <button id="check-devices-btn" class="text-blue-300 hover:text-blue-200 underline text-sm mt-2 flex items-center">
                <i data-feather="settings" class="h-4 w-4 mr-1"></i>
                {% trans "Check Camera and Microphone" %}
            </button>
        </div>
    </div>
</div>

<div class="session-room bg-gray-100 flex flex-col md:flex-row">
    <!-- Main Content Area (Video + Whiteboard) - 70% width -->
    <div class="flex-grow md:w-[70%] flex flex-col p-4">
        <!-- Session Info Banner -->
        <div class="bg-white rounded-lg shadow-sm p-3 mb-4 flex flex-col md:flex-row md:justify-between md:items-center">
            <div>
                <h1 class="text-lg font-bold">{{ session.title }}</h1>
                <p class="text-sm text-gray-600">{{ session.start_time|date:"F j, Y" }} | {{ session.start_time|date:"g:i A" }} - {{ session.end_time|date:"g:i A" }}</p>
            </div>
            <div class="flex flex-wrap items-center mt-2 md:mt-0">
                <!-- Session Timer -->
                <div class="mr-4 flex flex-col items-center">
                    <span class="text-xs text-gray-500">{% trans "Session ends in" %}</span>
                    <span id="session-timer" class="font-mono text-sm font-bold" 
                          data-end-time="{{ session.end_time|date:'c' }}">00:00:00</span>
                </div>
                
                <!-- Session Status -->
                <div class="bg-green-100 text-green-800 text-xs font-medium px-2.5 py-0.5 rounded-full mr-4 flex items-center">
                    <span class="inline-block h-2 w-2 rounded-full bg-green-500 mr-1 animate-pulse"></span>
                    {% trans "Live" %}
                </div>
                
                <!-- Leave Button (Hidden on Mobile) -->
                <div class="hidden md:flex items-center border-l border-gray-300 pl-4">
                    <button id="leave-session" class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 transition">
                        {% trans "Leave Session" %}
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Main Display Area (Video/Whiteboard) -->
        <div class="flex-grow relative">
            <!-- Video Grid -->
            <div id="videos-content" class="h-full">
                <div id="video-grid" class="grid grid-cols-1 gap-4 h-full">
                    <!-- Mentor Video -->
                    <div class="video-container mentor">
                        <video id="local-video" autoplay muted playsinline></video>
                        <div class="label">
                            {% if is_mentor %}{% trans "You (Mentor)" %}{% else %}{% trans "You" %}{% endif %}
                        </div>
                        
                        <!-- Network Quality Indicator -->
                        <div id="network-quality" class="network-quality good">
                            <i data-feather="wifi" class="h-3 w-3"></i>
                            <span>{% trans "Good" %}</span>
                        </div>
                        
                        <!-- Buffering Indicator -->
                        <div class="buffering-indicator">
                            <div class="spinner"></div>
                            <div class="text">{% trans "Buffering..." %}</div>
                        </div>
                        
                        <!-- Enhanced Video Controls Panel -->
                        <div class="absolute inset-0 flex flex-col items-center justify-center opacity-0 hover:opacity-100 transition-opacity duration-200 bg-black bg-opacity-40">
                            <!-- Main Controls Row -->
                            <div class="flex space-x-5 mb-3">
                                <!-- Video Toggle with status indicator -->
                                <div class="flex flex-col items-center">
                                    <button id="video-toggle" class="bg-black bg-opacity-70 text-white w-12 h-12 rounded-full flex items-center justify-center hover:bg-opacity-90 transition">
                                        <i data-feather="video" class="h-6 w-6"></i>
                                    </button>
                                    <span id="video-status" class="text-white text-xs mt-1 opacity-80">On</span>
                                </div>
                                
                                <!-- Audio Toggle with status indicator -->
                                <div class="flex flex-col items-center">
                                    <button id="audio-toggle" class="bg-black bg-opacity-70 text-white w-12 h-12 rounded-full flex items-center justify-center hover:bg-opacity-90 transition">
                                        <i data-feather="mic" class="h-6 w-6"></i>
                                    </button>
                                    <span id="audio-status" class="text-white text-xs mt-1 opacity-80">On</span>
                                </div>
                                
                                <!-- Screen Share with status indicator -->
                                <div class="flex flex-col items-center">
                                    <button id="screen-share" class="bg-black bg-opacity-70 text-white w-12 h-12 rounded-full flex items-center justify-center hover:bg-opacity-90 transition">
                                        <i data-feather="monitor" class="h-6 w-6"></i>
                                    </button>
                                    <span id="screen-status" class="text-white text-xs mt-1 opacity-80">Share</span>
                                </div>
                            </div>
                            
                            <!-- Advanced Controls Row -->
                            <div class="flex space-x-3">
                                <!-- Raise Hand (for learners only) -->
                                {% if not is_mentor %}
                                <div class="flex flex-col items-center">
                                    <button id="raise-hand" class="bg-black bg-opacity-70 text-white w-10 h-10 rounded-full flex items-center justify-center hover:bg-opacity-90 transition">
                                        <i data-feather="hand" class="h-5 w-5"></i>
                                    </button>
                                    <span class="text-white text-xs mt-1 opacity-80">Raise</span>
                                </div>
                                {% endif %}
                                
                                <!-- Leave/Rejoin Button -->
                                <div class="flex flex-col items-center">
                                    <button id="leave-rejoin" class="bg-red-600 text-white w-10 h-10 rounded-full flex items-center justify-center hover:bg-red-700 transition">
                                        <i data-feather="refresh-cw" class="h-5 w-5"></i>
                                    </button>
                                    <span class="text-white text-xs mt-1 opacity-80">Rejoin</span>
                                </div>
                                
                                <!-- Settings Button -->
                                <div class="flex flex-col items-center">
                                    <button id="video-settings" class="bg-black bg-opacity-70 text-white w-10 h-10 rounded-full flex items-center justify-center hover:bg-opacity-90 transition">
                                        <i data-feather="settings" class="h-5 w-5"></i>
                                    </button>
                                    <span class="text-white text-xs mt-1 opacity-80">Settings</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Enhanced Mini Controls (always visible) -->
                        <div class="controls flex space-x-2">
                            <button id="video-toggle-mini" class="control-btn bg-black bg-opacity-70 hover:bg-opacity-90 transition" title="Toggle Video">
                                <i data-feather="video" class="h-5 w-5"></i>
                            </button>
                            <button id="audio-toggle-mini" class="control-btn bg-black bg-opacity-70 hover:bg-opacity-90 transition" title="Toggle Audio">
                                <i data-feather="mic" class="h-5 w-5"></i>
                            </button>
                            <button id="leave-rejoin-mini" class="control-btn bg-red-600 hover:bg-red-700 transition" title="Leave/Rejoin">
                                <i data-feather="refresh-cw" class="h-5 w-5"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Chat Panel (initially hidden on desktop) -->
            <div id="chat-content" class="hidden h-full flex flex-col">
                <div id="chat-messages" class="chat-messages">
                    <!-- Chat messages will be inserted here -->
                    <div class="chat-message system">
                        <div class="chat-bubble system bg-gray-200 text-center text-sm py-1">
                            {% trans "Session started. Welcome!" %}
                        </div>
                    </div>
                </div>
                <form id="chat-form" class="chat-form">
                    <input type="text" id="chat-input" class="chat-input" placeholder="{% trans 'Type your message...' %}">
                    <button type="submit" class="chat-submit">
                        <i data-feather="send" class="h-5 w-5"></i>
                    </button>
                </form>
            </div>
            
            <!-- Whiteboard Panel (initially hidden) -->
            <div id="whiteboard-content" class="hidden h-full flex flex-col">
                <!-- Whiteboard Toolbar -->
                <div class="bg-white p-2 border-b border-gray-200 flex items-center space-x-2">
                    <!-- Color Picker -->
                    <div class="flex space-x-2">
                        <button class="w-6 h-6 rounded-full bg-black hover:ring-2 ring-offset-1 ring-gray-400" data-color="#000000"></button>
                        <button class="w-6 h-6 rounded-full bg-red-600 hover:ring-2 ring-offset-1 ring-gray-400" data-color="#dc2626"></button>
                        <button class="w-6 h-6 rounded-full bg-blue-600 hover:ring-2 ring-offset-1 ring-gray-400" data-color="#2563eb"></button>
                        <button class="w-6 h-6 rounded-full bg-green-600 hover:ring-2 ring-offset-1 ring-gray-400" data-color="#16a34a"></button>
                        <button class="w-6 h-6 rounded-full bg-yellow-500 hover:ring-2 ring-offset-1 ring-gray-400" data-color="#eab308"></button>
                    </div>
                    
                    <!-- Divider -->
                    <div class="h-8 border-l border-gray-300"></div>
                    
                    <!-- Tool Picker -->
                    <div class="flex space-x-2">
                        <button id="wb-pen-tool" class="w-8 h-8 rounded hover:bg-gray-100 p-1 active bg-gray-200" title="{% trans 'Pen' %}">
                            <i data-feather="pen-tool" class="h-6 w-6"></i>
                        </button>
                        <button id="wb-square-tool" class="w-8 h-8 rounded hover:bg-gray-100 p-1" title="{% trans 'Rectangle' %}">
                            <i data-feather="square" class="h-6 w-6"></i>
                        </button>
                        <button id="wb-circle-tool" class="w-8 h-8 rounded hover:bg-gray-100 p-1" title="{% trans 'Circle' %}">
                            <i data-feather="circle" class="h-6 w-6"></i>
                        </button>
                        <button id="wb-text-tool" class="w-8 h-8 rounded hover:bg-gray-100 p-1" title="{% trans 'Text' %}">
                            <i data-feather="type" class="h-6 w-6"></i>
                        </button>
                        <button id="wb-eraser-tool" class="w-8 h-8 rounded hover:bg-gray-100 p-1" title="{% trans 'Eraser' %}">
                            <i data-feather="delete" class="h-6 w-6"></i>
                        </button>
                    </div>
                    
                    <!-- Divider -->
                    <div class="h-8 border-l border-gray-300"></div>
                    
                    <!-- Line Width -->
                    <div class="flex items-center space-x-2">
                        <span class="text-sm text-gray-600">{% trans "Width" %}:</span>
                        <input type="range" min="1" max="20" value="3" class="w-24" id="wb-line-width">
                    </div>
                    
                    <!-- Divider -->
                    <div class="h-8 border-l border-gray-300"></div>
                    
                    <!-- Actions -->
                    <div class="flex space-x-2 ml-auto">
                        <button id="wb-undo" class="w-8 h-8 rounded hover:bg-gray-100 p-1" title="{% trans 'Undo' %}">
                            <i data-feather="corner-up-left" class="h-6 w-6"></i>
                        </button>
                        <button id="wb-clear" class="w-8 h-8 rounded hover:bg-gray-100 p-1" title="{% trans 'Clear All' %}">
                            <i data-feather="trash-2" class="h-6 w-6"></i>
                        </button>
                        <button id="wb-save" class="w-8 h-8 rounded hover:bg-gray-100 p-1" title="{% trans 'Save' %}">
                            <i data-feather="download" class="h-6 w-6"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Whiteboard Canvas Container -->
                <div class="whiteboard-container flex-grow overflow-hidden bg-white">
                    <canvas id="whiteboard-canvas" class="w-full h-full"></canvas>
                </div>
                
                <!-- Mentor Controls (only visible to mentor) -->
                {% if is_mentor %}
                <div class="bg-blue-50 p-2 border-t border-blue-200 flex justify-between items-center">
                    <span class="text-sm text-blue-800">{% trans "Mentor Controls" %}</span>
                    <div class="flex space-x-2">
                        <button id="wb-allow-all" class="text-xs bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700">
                            {% trans "Allow All to Draw" %}
                        </button>
                        <button id="wb-disallow-all" class="text-xs bg-gray-600 text-white px-3 py-1 rounded hover:bg-gray-700">
                            {% trans "Disable Drawing" %}
                        </button>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Mobile Bottom Tab Bar (visible only on mobile) -->
        <div class="md:hidden flex justify-around border-t border-gray-200 pt-2 mt-2">
            <button id="videos-tab-mobile" class="flex flex-col items-center text-blue-600">
                <i data-feather="video" class="h-6 w-6"></i>
                <span class="text-xs mt-1">{% trans "Videos" %}</span>
            </button>
            <button id="chat-tab-mobile" class="flex flex-col items-center text-gray-500 relative">
                <i data-feather="message-circle" class="h-6 w-6"></i>
                <span class="text-xs mt-1">{% trans "Chat" %}</span>
            </button>
            <button id="whiteboard-tab-mobile" class="flex flex-col items-center text-gray-500">
                <i data-feather="edit-3" class="h-6 w-6"></i>
                <span class="text-xs mt-1">{% trans "Whiteboard" %}</span>
            </button>
            <button id="leave-session-mobile" class="flex flex-col items-center text-red-600">
                <i data-feather="log-out" class="h-6 w-6"></i>
                <span class="text-xs mt-1">{% trans "Leave" %}</span>
            </button>
        </div>
    </div>
    
    <!-- Sidebar (hidden on mobile) - 30% width -->
    <div class="hidden md:flex md:w-[30%] bg-white shadow-sm flex-col">
        <!-- Tabs -->
        <div class="flex border-b border-gray-200">
            <div id="topics-tab" class="tab active border-blue-500 text-blue-600">
                {% trans "Topics" %}
            </div>
            <div id="chat-tab" class="tab relative">
                {% trans "Chat" %}
            </div>
            <div id="transcript-tab" class="tab">
                {% trans "Transcript" %}
            </div>
        </div>
        
        <!-- Tab Content -->
        <div class="flex-grow overflow-hidden">
            <!-- Topics List (when Topics tab is active) -->
            <div id="topics-list" class="p-4">
                <h3 class="font-medium mb-3">{% trans "Topics to Cover" %}</h3>
                <ul class="space-y-2" id="session-topics">
                    {% if session.description %}
                        {% with topics=session.description|linebreaksbr|safe %}
                            {% for line in topics|split_lines %}
                                <li class="flex items-start p-2 rounded-md border border-gray-100">
                                    <div class="flex-shrink-0 mt-0.5 mr-3">
                                        <input type="checkbox" class="topic-checkbox h-5 w-5 rounded text-blue-600 focus:ring-blue-500" 
                                              {% if is_mentor %}{% else %}disabled{% endif %}>
                                    </div>
                                    <div class="flex-grow">
                                        <p class="text-sm">{{ line|trim }}</p>
                                    </div>
                                </li>
                            {% empty %}
                                <li class="p-2 text-sm text-gray-500">{% trans "No specific topics listed for this session." %}</li>
                            {% endfor %}
                        {% endwith %}
                    {% else %}
                        <li class="p-2 text-sm text-gray-500">{% trans "No specific topics listed for this session." %}</li>
                    {% endif %}
                </ul>
                
                <div class="mt-6">
                    <h3 class="font-medium mb-3">{% trans "Participants" %}</h3>
                    <ul class="space-y-2">
                        {% if is_mentor %}
                            <li class="flex items-center p-2 bg-blue-50 rounded-md">
                                <div class="h-8 w-8 rounded-full bg-blue-500 text-white flex items-center justify-center font-bold mr-3">
                                    {{ user.first_name|first|upper }}
                                </div>
                                <div>
                                    <div class="font-medium">{{ user.get_full_name }}</div>
                                    <div class="text-xs text-blue-600">{% trans "Mentor" %}</div>
                                </div>
                            </li>
                        {% endif %}
                        
                        {% for participant in participants %}
                            <li class="flex items-center p-2 {% if participant.id == user.id %}bg-blue-50{% else %}hover:bg-gray-50{% endif %} rounded-md">
                                <div class="h-8 w-8 rounded-full bg-gray-500 text-white flex items-center justify-center font-bold mr-3">
                                    {{ participant.first_name|first|upper }}
                                </div>
                                <div>
                                    <div class="font-medium">{{ participant.get_full_name }}</div>
                                    <div class="text-xs text-gray-500">{% trans "Learner" %}</div>
                                </div>
                            </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
            
            <!-- Chat Panel (initially hidden) -->
            <div id="chat-content" class="hidden h-full flex flex-col">
                <div id="chat-messages" class="chat-messages">
                    <!-- Chat messages will be inserted here -->
                    <div class="chat-message system">
                        <div class="chat-bubble system bg-gray-200 text-center text-sm py-1">
                            {% trans "Session started. Welcome!" %}
                        </div>
                    </div>
                </div>
                <form id="chat-form" class="chat-form">
                    <input type="text" id="chat-input" class="chat-input" placeholder="{% trans 'Type your message...' %}">
                    <button type="submit" class="chat-submit">
                        <i data-feather="send" class="h-5 w-5"></i>
                    </button>
                </form>
            </div>
            
            <!-- Transcript Panel (initially hidden) -->
            <div id="transcript-content" class="hidden h-full flex flex-col overflow-y-auto p-4">
                <h3 class="font-medium mb-3">{% trans "Live Transcript" %}</h3>
                <div id="transcript-container" class="flex-grow space-y-4">
                    <p class="text-sm text-gray-500 italic">{% trans "Real-time transcript will appear here when speech is detected..." %}</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- WebRTC scripts -->
<script src="{% static 'js/webrtc/webrtc_enhanced.js' %}" type="text/javascript"></script>
<script src="{% static 'js/webrtc/session-ui.js' %}" type="text/javascript"></script>

<!-- Sound files for notifications -->
<audio id="notification-5min" preload="auto">
    <source src="{% static 'sounds/notification-5min.mp3' %}" type="audio/mpeg">
</audio>
<audio id="notification-1min" preload="auto">
    <source src="{% static 'sounds/notification-1min.mp3' %}" type="audio/mpeg">
</audio>
<audio id="notification-10sec" preload="auto">
    <source src="{% static 'sounds/notification-10sec.mp3' %}" type="audio/mpeg">
</audio>
<audio id="session-start" preload="auto">
    <source src="{% static 'sounds/session-start.mp3' %}" type="audio/mpeg">
</audio>

<!-- Enhanced Pre-session Countdown Timer -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Get elements
    const readyBtn = document.getElementById('ready-btn');
    const checkDevicesBtn = document.getElementById('check-devices-btn');
    const preSessionOverlay = document.getElementById('pre-session-overlay');
    const countdownTimer = document.getElementById('countdown-timer');
    const sessionTimer = document.getElementById('session-timer');
    const localVideo = document.getElementById('local-video');
    
    // Get session times from the data attributes
    const sessionEndTime = new Date(sessionTimer.dataset.endTime);
    
    // Calculate start time as 15 minutes before end time minus session duration
    // This is just for testing the countdown in development
    const sessionStartTime = new Date(sessionEndTime);
    sessionStartTime.setMinutes(sessionStartTime.getMinutes() - 30); // 30 minute test session
    
    // State variables
    let isPreSessionReady = false;
    let mediaStream = null;
    
    // Update countdown timer
    function updateCountdown() {
        const now = new Date();
        
        // If session hasn't started yet, show time until start
        if (now < sessionStartTime) {
            const diff = sessionStartTime - now;
            
            // Calculate hours, minutes, seconds
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diff % (1000 * 60)) / 1000);
            
            // Update countdown display
            countdownTimer.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            countdownTimer.style.color = '#3b82f6'; // Blue color for waiting
            
            // Update message based on time left
            if (diff < 5 * 60 * 1000) { // Less than 5 minutes
                document.getElementById('countdown-message').innerHTML = 
                    `<span class="text-red-600 font-bold">{% trans "Your session starts in less than 5 minutes!" %}</span><br>
                     {% trans "Click 'I'm Ready' to join the session now." %}`;
                
                // Add pulsing animation to button
                readyBtn.classList.add('animate-pulse');
            }
            
            return false; // Session not started
        } 
        // Session in progress
        else if (now < sessionEndTime) {
            const diff = sessionEndTime - now;
            
            // Calculate hours, minutes, seconds
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diff % (1000 * 60)) / 1000);
            
            // Update countdown display to show time remaining
            countdownTimer.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            // Change color based on time left
            if (diff < 5 * 60 * 1000) {
                countdownTimer.style.color = '#ef4444'; // Red for <5 minutes left
                countdownTimer.classList.add('animate-pulse');
            } else if (diff < 10 * 60 * 1000) {
                countdownTimer.style.color = '#f59e0b'; // Amber for <10 minutes left
            } else {
                countdownTimer.style.color = '#10b981'; // Green for plenty of time
            }
            
            // If user is ready, they should have joined already
            if (isPreSessionReady) {
                return true; // Session started and user ready
            } else {
                // Display "join now" message for started session
                document.getElementById('countdown-message').innerHTML = 
                    `<span class="bg-green-100 text-green-800 font-bold px-3 py-1 rounded">{% trans "SESSION IN PROGRESS" %}</span><br>
                     {% trans "Join now to avoid missing content!" %}`;
                return true; // Session started but waiting for user
            }
        } 
        // Session ended
        else {
            // Session already ended
            countdownTimer.textContent = `00:00:00`;
            countdownTimer.style.color = '#ef4444'; // Red for time's up
            document.getElementById('countdown-message').innerHTML = 
                `<span class="text-red-600 font-bold">{% trans "The scheduled session time has ended." %}</span><br>
                 {% trans "You can still join but the mentor may have left." %}`;
            return true; // Session already over
        }
    }
    
    // Initialize media devices
    async function initializeMedia() {
        try {
            // Request audio and video
            mediaStream = await navigator.mediaDevices.getUserMedia({
                video: true,
                audio: true
            });
            
            // Connect to video preview
            if (localVideo) {
                localVideo.srcObject = mediaStream;
                localVideo.play().catch(e => console.warn("Couldn't auto-play preview:", e));
            }
            
            return true;
        } catch (error) {
            console.error("Error accessing camera/microphone:", error);
            alert("{% trans 'Please allow access to your camera and microphone to join the session.' %}");
            return false;
        }
    }
    
    // Handle ready button click
    readyBtn.addEventListener('click', async function() {
        isPreSessionReady = true;
        
        // Initialize media if not already done
        if (!mediaStream) {
            const success = await initializeMedia();
            if (!success) return;
        }
        
        // Hide overlay with animation
        preSessionOverlay.classList.add('fade-out');
        setTimeout(() => {
            preSessionOverlay.style.display = 'none';
        }, 300);
    });
    
    // Handle check devices button
    checkDevicesBtn.addEventListener('click', function() {
        initializeMedia();
    });
    
    // Start countdown timer
    updateCountdown();
    setInterval(updateCountdown, 1000);
    
    // Try to initialize media on page load
    initializeMedia();
});
</script>

<!-- Main WebRTC Session Script -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Feather icons
    if (typeof feather !== 'undefined') {
        feather.replace();
    }
    
    // Initialize session UI controller
    const sessionUI = new SessionUIController();
    sessionUI.initEventListeners();
    
    // Initialize WebRTC using our extracted function
    initializeWebRTC(sessionUI);
        
        // WebRTC configuration
        const config = {
            // User and session details
            userId: '{{ user.id }}',
            userName: '{{ user.get_full_name }}',
            sessionId: '{{ session.id }}',
            isMentor: {% if is_mentor %}true{% else %}false{% endif %},
            
            // WebSocket signaling URL
            signalingUrl: `${window.location.protocol === 'https:' ? 'wss:' : 'ws:'}//${window.location.host}/ws/session/{{ session.id }}/`,
            
            // Video elements
            localVideo: document.getElementById('local-video'),
            
            // ICE servers configuration
            iceServers: [
                {urls: defaultStunServers}
            ],
            
            // UI callbacks
            onError: function(message) {
                sessionUI.showErrorMessage(message);
            },
            
            onConnectionStateChange: function(state) {
                sessionUI.updateConnectionStatus(state);
            },
            
            onRejoinSuccess: function() {
                sessionUI.showSuccessMessage("{% trans 'Successfully reconnected to session!' %}");
            },
            
            onRemoteStream: function(userId, userName, stream) {
                sessionUI.addRemoteVideo(userId, userName, stream);
            },
            
            onRemoteStreamRemoved: function(userId) {
                sessionUI.removeRemoteVideo(userId);
            },
            
            onMessage: function(message) {
                if (message.type === 'chat') {
                    sessionUI.addChatMessage(message.from_user_id, message.user_name, message.text);
                } else if (message.type === 'raise_hand') {
                    sessionUI.handleRaiseHand(message);
                } else if (message.type === 'whiteboard_data') {
                    sessionUI.handleWhiteboardData(message);
                } else if (message.type === 'screen_share') {
                    // Handle screen share notifications
                    if (message.action === 'start') {
                        sessionUI.showNotification(`${message.user_name} started sharing their screen`);
                    } else if (message.action === 'stop') {
                        sessionUI.showNotification(`${message.user_name} stopped sharing their screen`);
                    }
                }
            }
        };
        
        // Create and initialize the WebRTC connection
        const peerConnection = new PeerLearnRTC(config);
        
        // Store reference in session UI for controls
        sessionUI.rtc = peerConnection;
        
        // Initialize the connection
        peerConnection.init().then(() => {
            console.log('WebRTC connection initialized successfully');
            sessionUI.showSuccessMessage("{% trans 'Connected to session room!' %}");
        }).catch(err => {
            console.error('Failed to initialize WebRTC connection:', err);
            sessionUI.showErrorMessage("{% trans 'Failed to connect to session. Please try refreshing the page.' %}");
        });
        
    } catch (error) {
        console.error('Error setting up WebRTC:', error);
        alert("{% trans 'There was a problem connecting to the session. Please refresh the page and try again.' %}");
    }
});
</script>

<script type="text/javascript">
    // Notification System class
    class NotificationSystem {
        constructor() {
            this.sounds = {
                fiveMin: document.getElementById('notification-5min'),
                oneMin: document.getElementById('notification-1min'), 
                tenSec: document.getElementById('notification-10sec'),
                sessionStart: document.getElementById('session-start')
            };
            
            // Keep track of which alerts have been played
            this.alertsPlayed = {
                fiveMin: false,
                oneMin: false,
                tenSec: false,
                sessionStart: false
            };
            
            console.log("Notification system initialized");
        }
        
        playSound(soundId) {
            const sound = this.sounds[soundId];
            if (sound) {
                // Reset the audio to beginning
                sound.currentTime = 0;
                
                // Play the sound using promise with old-style then method
                var playPromise = sound.play();
                
                // Handle errors for browsers that return a promise from play()
                if (playPromise !== undefined) {
                    playPromise.then(function() {
                        // Playback started successfully
                    }).catch(function(error) {
                        console.error('Error playing sound:', error);
                    });
                }
            }
        }
        
        // Check time remaining and play appropriate sounds
        checkTimeAndNotify(timeToStart) {
            // Convert milliseconds to seconds
            const secondsToStart = Math.floor(timeToStart / 1000);
            
            // Play sounds at specific time intervals
            if (secondsToStart <= 300 && secondsToStart > 60 && !this.alertsPlayed.fiveMin) {
                this.playSound('fiveMin');
                this.alertsPlayed.fiveMin = true;
                console.log("5-minute notification played");
            } else if (secondsToStart <= 60 && secondsToStart > 10 && !this.alertsPlayed.oneMin) {
                this.playSound('oneMin');
                this.alertsPlayed.oneMin = true;
                console.log("1-minute notification played");
            } else if (secondsToStart <= 10 && secondsToStart > 0 && !this.alertsPlayed.tenSec) {
                this.playSound('tenSec');
                this.alertsPlayed.tenSec = true;
                console.log("10-second notification played");
            } else if (secondsToStart <= 0 && !this.alertsPlayed.sessionStart) {
                this.playSound('sessionStart');
                this.alertsPlayed.sessionStart = true;
                console.log("Session start notification played");
            }
        }
    }
    
    // Session Timer class
    class SessionTimer {
        constructor(options) {
            this.startTime = new Date(options.startTime);
            this.endTime = new Date(options.endTime);
            this.countdownEl = document.getElementById(options.countdownId);
            this.countdownOverlay = document.getElementById(options.overlayId);
            this.sessionTimerEl = document.getElementById(options.sessionTimerId);
            this.notification = options.notificationSystem;
            this.onSessionStart = options.onSessionStart;
            this.onSessionEnd = options.onSessionEnd;
            this.interval = null;
            this.sessionStarted = false;
            
            // Initialize ready button if it exists
            const readyBtn = document.getElementById('ready-btn');
            if (readyBtn) {
                readyBtn.addEventListener('click', () => {
                    // Hide the overlay when user is ready
                    if (this.countdownOverlay) {
                        this.countdownOverlay.classList.add('hidden');
                    }
                });
            }
        }
        
        // Format time as HH:MM:SS
        formatTime(time) {
            const hours = Math.floor(time / 3600);
            const minutes = Math.floor((time % 3600) / 60);
            const seconds = time % 60;
            
            return [hours, minutes, seconds]
                .map(v => v < 10 ? "0" + v : v)
                .join(":");
        }
        
        // Start the timer
        start() {
            this.interval = setInterval(() => this.update(), 1000);
            this.update(); // Initial update
        }
        
        // Stop the timer
        stop() {
            if (this.interval) {
                clearInterval(this.interval);
                this.interval = null;
            }
        }
        
        // Update timer displays
        update() {
            const now = new Date();
            const timeToStart = this.startTime - now;
            const timeToEnd = this.endTime - now;
            
            console.log("Session time data:", {
                now: now.toISOString(),
                startTime: this.startTime.toISOString(),
                endTime: this.endTime.toISOString(),
                timeToStart,
                timeToEnd
            });
            
            // Update countdown timer if session hasn't started
            if (timeToStart > 0) {
                // We're in pre-session state
                const secondsToStart = Math.floor(timeToStart / 1000);
                
                // Show the countdown overlay if it exists
                if (this.countdownOverlay && !this.countdownOverlay.classList.contains('hidden') === false) {
                    this.countdownOverlay.classList.remove('hidden');
                }
                
                // Update countdown display
                if (this.countdownEl) {
                    this.countdownEl.textContent = this.formatTime(secondsToStart);
                }
                
                // Check for notifications
                if (this.notification) {
                    this.notification.checkTimeAndNotify(timeToStart);
                }
            } 
            // Session has started but not ended
            else if (timeToEnd > 0) {
                // Hide countdown overlay if it exists
                if (this.countdownOverlay && !this.countdownOverlay.classList.contains('hidden')) {
                    this.countdownOverlay.classList.add('hidden');
                }
                
                // Call onSessionStart callback once
                if (!this.sessionStarted) {
                    this.sessionStarted = true;
                    if (this.onSessionStart) this.onSessionStart();
                }
                
                // Update session timer
                if (this.sessionTimerEl) {
                    const secondsToEnd = Math.floor(timeToEnd / 1000);
                    this.sessionTimerEl.textContent = this.formatTime(secondsToEnd);
                }
            } 
            // Session has ended
            else {
                // Call onSessionEnd callback
                if (this.onSessionEnd) this.onSessionEnd();
                this.stop();
            }
        }
    }
    
    // Initialize WebRTC function
    function initializeWebRTC(sessionUI) {
        try {
            console.log('Initializing WebRTC connection for {{ session.id }}');
            
            // Default STUN servers in case none are provided from backend
            const defaultStunServers = [
                'stun:stun.l.google.com:19302',
                'stun:stun1.l.google.com:19302',
                'stun:stun2.l.google.com:19302'
            ];
            
            // Log configuration for debugging
            console.log('WebRTC Configuration:');
            console.log('- User ID: {{ user.id }}');
            console.log('- User Name: {{ user.get_full_name }}');
            console.log('- Session ID: {{ session.id }}');
            console.log('- Is Mentor: {% if is_mentor %}true{% else %}false{% endif %}');
            
            // Initialize RTC with complete configuration
            sessionUI.initRTC({
                userId: '{{ user.id }}',
                userName: '{{ user.get_full_name }}',
                sessionId: '{{ session.id }}',
                isMentor: {% if is_mentor %}true{% else %}false{% endif %},
                localVideoId: 'local-video',
                // Use provided STUN servers or fallback to defaults
                stunServers: [
                    {% for server in stun_servers %}'{{ server }}'{% if not forloop.last %}, {% endif %}{% empty %}
                    'stun:stun.l.google.com:19302',
                    'stun:stun1.l.google.com:19302',
                    'stun:stun2.l.google.com:19302'
                    {% endfor %}
                ],
                // Use provided TURN servers or empty array
                turnServers: [
                    {% for server in turn_servers %}'{{ server }}'{% if not forloop.last %}, {% endif %}{% endfor %}
                ],
                turnUsername: '{{ turn_username|default:"" }}',
                turnCredential: '{{ turn_credential|default:"" }}',
                // Set additional options for better reliability
                debugMode: true,
                connectionTimeout: 30000, // 30 seconds
                reconnectAttempts: 5
            });
            
            console.log('WebRTC initialization complete');
        } catch (error) {
            console.error('Error initializing WebRTC:', error);
            // Show error message to user
            alert('Failed to initialize video connection. Please refresh the page to try again.');
        }
    }
        
        // Add custom event handlers for WebRTC messages
        if (sessionUI.rtc) {
            // Extend the handleSignalingMessage function to include new message types
            const originalHandleSignaling = sessionUI.rtc.handleSignalingMessage;
            sessionUI.rtc.handleSignalingMessage = function(data) {
                // First call the original method for standard message types
                originalHandleSignaling.call(this, data);
                
                // Then handle our custom message types
                switch (data.type) {
                    case 'user_rejoin':
                        // Handle a user who has rejoined the session
                        sessionUI.addSystemMessage(`${data.user_name} has reconnected to the session.`);
                        // If we're the mentor and a learner is rejoining, we need to create a new connection to them
                        if (sessionUI.rtc.isMentor && data.user_id !== sessionUI.rtc.userId) {
                            console.log("Mentor received rejoin notification from learner, initiating connection");
                            setTimeout(() => {
                                // Small delay to ensure both sides are ready
                                sessionUI.rtc.createPeerConnection(data.user_id, data.user_name);
                                sessionUI.rtc.createOffer(data.user_id);
                            }, 1000);
                        }
                        break;
                    case 'raise_hand':
                        sessionUI.handleRaiseHand(data);
                        break;
                    case 'whiteboard_data':
                        sessionUI.handleWhiteboardData(data);
                        break;
                    case 'whiteboard_clear':
                        sessionUI.clearWhiteboard(false);
                        sessionUI.addSystemMessage(`${data.from_user_name || 'A participant'} cleared the whiteboard.`);
                        break;
                    case 'whiteboard_undo':
                        // This would be more complex in a real app
                        sessionUI.addSystemMessage(`${data.from_user_name || 'A participant'} undid their last action.`);
                        break;
                    case 'whiteboard_permissions':
                        // Handle whiteboard permission changes
                        if (!sessionUI.whiteboard) return;
                        
                        const msg = data.allowAll ? 
                            "The mentor has enabled drawing for all participants." : 
                            "The mentor has disabled drawing for participants.";
                        
                        sessionUI.addSystemMessage(msg);
                        
                        // Only update UI if you're not the mentor
                        if (!{% if is_mentor %}true{% else %}false{% endif %}) {
                            sessionUI.whiteboardCanvas.style.pointerEvents = data.allowAll ? 'auto' : 'none';
                        }
                        break;
                    case 'screen_share':
                        // In a full implementation, we would handle remote screen sharing
                        // This would require additional WebRTC video track handling
                        if (data.action === 'start') {
                            sessionUI.addSystemMessage(`${data.from_user_name || 'A participant'} started sharing their screen.`);
                        } else if (data.action === 'stop') {
                            sessionUI.addSystemMessage(`${data.from_user_name || 'A participant'} stopped sharing their screen.`);
                        }
                        break;
                }
            };
        }
        
        // Initialize and start the session timer
        const notificationSystem = new NotificationSystem();
        const sessionTimer = new SessionTimer({
            startTime: '{{ session.start_time|date:"c" }}',
            endTime: '{{ session.end_time|date:"c" }}',
            countdownId: 'countdown-timer',
            overlayId: 'pre-session-overlay',
            sessionTimerId: 'session-timer',
            notificationSystem: notificationSystem,
            onSessionStart: function() {
                console.log('Session started!');
                // Add any additional logic for when the session starts
                
                // Show system message in chat
                const chatMessages = document.getElementById('chat-messages');
                if (chatMessages) {
                    const systemMessage = document.createElement('div');
                    systemMessage.className = 'chat-message system';
                    systemMessage.innerHTML = `
                        <div class="chat-bubble system">
                            {% trans "Session has officially started! Welcome everyone." %}
                        </div>
                    `;
                    chatMessages.appendChild(systemMessage);
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }
            },
            onSessionEnd: function() {
                console.log('Session ended!');
                
                // Show end message and redirect options
                const mainContent = document.querySelector('.session-room');
                if (mainContent) {
                    const sessionEndOverlay = document.createElement('div');
                    sessionEndOverlay.className = 'pre-session-overlay';
                    sessionEndOverlay.innerHTML = `
                        <div class="text-2xl font-bold mb-4">{% trans "Session Ended" %}</div>
                        <div class="countdown-message">
                            {% trans "Thank you for participating in this session! We hope you found it valuable." %}
                        </div>
                        <div class="flex space-x-4 mt-6">
                            <a href="{% if is_mentor %}{% url 'mentor_dashboard' %}{% else %}{% url 'learner_dashboard' %}{% endif %}" 
                               class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg transition">
                                {% trans "Back to Dashboard" %}
                            </a>
                            {% if not is_mentor %}
                            <a href="{% url 'submit_feedback' booking.id %}" 
                               class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg transition">
                                {% trans "Leave Feedback" %}
                            </a>
                            {% endif %}
                        </div>
                    `;
                    document.body.appendChild(sessionEndOverlay);
                }
            }
        });
        
        // Start the timer
        sessionTimer.start();
        
        // Tab switching for sidebar
        document.getElementById('topics-tab').addEventListener('click', function() {
            // Hide all content
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active', 'border-blue-500', 'text-blue-600'));
            document.querySelectorAll('#topics-list, #chat-content, #transcript-content').forEach(content => content.classList.add('hidden'));
            
            // Show topics content
            this.classList.add('active', 'border-blue-500', 'text-blue-600');
            document.getElementById('topics-list').classList.remove('hidden');
        });
        
        document.getElementById('chat-tab').addEventListener('click', function() {
            // Hide all content
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active', 'border-blue-500', 'text-blue-600'));
            document.querySelectorAll('#topics-list, #chat-content, #transcript-content').forEach(content => content.classList.add('hidden'));
            
            // Show chat content
            this.classList.add('active', 'border-blue-500', 'text-blue-600');
            document.getElementById('chat-content').classList.remove('hidden');
        });
        
        document.getElementById('transcript-tab').addEventListener('click', function() {
            // Hide all content
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active', 'border-blue-500', 'text-blue-600'));
            document.querySelectorAll('#topics-list, #chat-content, #transcript-content').forEach(content => content.classList.add('hidden'));
            
            // Show transcript content
            this.classList.add('active', 'border-blue-500', 'text-blue-600');
            document.getElementById('transcript-content').classList.remove('hidden');
        });
        
        // Mobile tab switching
        document.getElementById('videos-tab-mobile').addEventListener('click', function() {
            sessionUI.switchTab('videos');
        });
        
        document.getElementById('chat-tab-mobile').addEventListener('click', function() {
            sessionUI.switchTab('chat');
        });
        
        document.getElementById('whiteboard-tab-mobile').addEventListener('click', function() {
            sessionUI.switchTab('whiteboard');
        });
        
        document.getElementById('leave-session-mobile').addEventListener('click', function() {
            sessionUI.leaveSession();
        });
        
        // Add data-user-id attributes to participant items for hand raising feature
        const participantItems = document.querySelectorAll('#participants-list li');
        participantItems.forEach(item => {
            const userId = item.querySelector('.user-id')?.textContent;
            if (userId) {
                item.setAttribute('data-user-id', userId);
            }
        });
        
        // Handle window resize to adjust whiteboard canvas size
        window.addEventListener('resize', function() {
            if (sessionUI.whiteboard && sessionUI.whiteboardCanvas) {
                const container = sessionUI.whiteboardCanvas.parentElement;
                const originalImageData = sessionUI.whiteboard.context.getImageData(
                    0, 0, sessionUI.whiteboardCanvas.width, sessionUI.whiteboardCanvas.height
                );
                
                sessionUI.whiteboardCanvas.width = container.offsetWidth;
                sessionUI.whiteboardCanvas.height = container.offsetHeight;
                
                // Restore drawing after resize
                sessionUI.whiteboard.context.putImageData(originalImageData, 0, 0);
            }
        });
    });
</script>
{% endblock %}